#!/bin/bash

# Th√¥ng tin c·ªßa b·∫°n
WEBHOOK_URL="https://discord.com/api/webhooks/1460633815578968239/E5Ck-CCpCwQNUtGXA9z-VpWwcQzZz7M7meSapdb8i7f0cZ_XdnOg4EHeCQ6x4rfmga_2"
TOKEN="pt70EXJbPWH+"

# D·ªçn d·∫πp nh·∫π nh√†ng (Ch·ªâ gi·∫øt pinggy li√™n quan ƒë·∫øn token n√†y)
ps aux | grep "${TOKEN}" | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null
tmux kill-session -t mctunnel 2>/dev/null

if [ -z "$TMUX" ]; then
    tmux new-session -d -s mctunnel "/bin/bash $0"
    echo "üöÄ ƒêang kh·ªüi ch·∫°y Tunnel Minecraft... Ki·ªÉm tra Discord sau 30s."
    exit
fi

while true
do
    rm -f mc_log.txt
    # S·ª≠ d·ª•ng l·ªánh SSH h·ªá th·ªëng (Nh·∫π h∆°n file ./pinggy r·∫•t nhi·ªÅu)
    ssh -p 443 -o StrictHostKeyChecking=accept-new -o ServerAliveInterval=10 "${TOKEN}tcp+udp@ap.free.pinggy.io" -R0:localhost:25565 > mc_log.txt 2>&1 &
    
    sleep 30

    # L·ªçc l·∫•y link s·∫°ch t·ª´ log
    RAW_LINE=$(grep -oE "(tcp:\/\/|udp:\/\/|)[a-zA-Z0-9.-]+\.free\.pinggy\.(io|link):[0-9]+" mc_log.txt | head -n 1)

    if [ -z "$RAW_LINE" ]; then
        echo "‚ö†Ô∏è Ch∆∞a l·∫•y ƒë∆∞·ª£c IP, ƒëang th·ª≠ l·∫°i..."
        sleep 20
        continue
    else
        # L√†m s·∫°ch IP cho Bedrock
        CLEAN_IP=$(echo "$RAW_LINE" | sed 's/tcp:\/\///g' | sed 's/udp:\/\///g')
        IP_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f1)
        PORT_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f2)

        PAYLOAD=$(cat <<EOF
{
  "embeds": [{
    "title": "üéÆ SERVER MINECRAFT ONLINE",
    "description": "Server ƒë√£ s·∫µn s√†ng! Ch√∫c c√°c b·∫°n ch∆°i game vui v·∫ª.",
    "color": 3066993,
    "fields": [
      { "name": "üñ•Ô∏è JAVA PC", "value": "\`$CLEAN_IP\`" },
      { "name": "üì± BEDROCK (PE)", "value": "IP: \`$IP_ONLY\`\nPort: \`$PORT_ONLY\`" }
    ],
    "footer": { "text": "H·ªá th·ªëng t·ª± ƒë·ªông reset sau 60 ph√∫t ƒë·ªÉ gi·ªØ ·ªïn ƒë·ªãnh" },
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  }]
}
EOF
)
        curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" $WEBHOOK_URL
        echo "‚úÖ ƒê√£ g·ª≠i IP l√™n Discord: $CLEAN_IP"
        
        # ƒê·ª£i 1 ti·∫øng r·ªìi m·ªõi reset tunnel
        sleep 3600
    fi
done
        continue
    else
        CLEAN_IP=$(echo "$RAW_LINE" | sed 's/tcp:\/\///g' | sed 's/udp:\/\///g')
        IP_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f1)
        PORT_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f2)

        PAYLOAD=$(cat <<EOF
{
  "embeds": [{
    "title": "‚úÖ SERVER MINECRAFT ONLINE",
    "color": 3066993,
    "fields": [
      { "name": "üñ•Ô∏è JAVA", "value": "\`$CLEAN_IP\`" },
      { "name": "üì± BEDROCK", "value": "IP: \`$IP_ONLY\`\nPort: \`$PORT_ONLY\`" }
    ]
  }]
}
EOF
)
        curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" $WEBHOOK_URL
        echo "‚úÖ ƒê√£ g·ª≠i IP l√™n Discord."
        sleep 3600
    fi
done
