#!/bin/bash

# --- C·∫§U H√åNH ---
WEBHOOK_URL="https://discord.com/api/webhooks/1460633815578968239/E5Ck-CCpCwQNUtGXA9z-VpWwcQzZz7M7meSapdb8i7f0cZ_XdnOg4EHeCQ6x4rfmga_2"
TOKEN="pt70EXJbPWH+"
JAVA_CMD="ssh -p 443 -R0:127.0.0.1:25565 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 ${TOKEN}tcp@ap.free.pinggy.io"
BEDROCK_CMD="./pinggy -p 443 -R0:127.0.0.1:25565 ${TOKEN}udp@ap.free.pinggy.io"

# --- KH·ªûI CH·∫†Y ---
echo "üöÄ ƒêang d·ªçn d·∫πp c√°c tunnel c≈©..."
pkill -9 ssh
pkill -9 pinggy
sleep 2

echo "üõ∞Ô∏è ƒêang kh·ªüi ch·∫°y Java Tunnel (TCP)..."
$JAVA_CMD > java_log.txt 2>&1 &

echo "üì± ƒêang kh·ªüi ch·∫°y Bedrock Tunnel (./pinggy)..."
$BEDROCK_CMD > bedrock_log.txt 2>&1 &

echo "‚è≥ ƒê·ª£i 20 gi√¢y ƒë·ªÉ h·ªá th·ªëng Pinggy c·∫•p IP Asia..."
sleep 20

# --- L·∫§Y IP ---
JAVA_IP=$(grep -oE "[a-zA-Z0-9.-]+\.a\.free\.pinggy\.(io|link):[0-9]+" java_log.txt | head -n 1)
BEDROCK_RAW=$(grep -oE "[a-zA-Z0-9.-]+\.a\.free\.pinggy\.(io|link):[0-9]+" bedrock_log.txt | head -n 1)

if [ -z "$JAVA_IP" ] || [ -z "$BEDROCK_RAW" ]; then
    echo "‚ö†Ô∏è L·ªói: Kh√¥ng l·∫•y ƒë∆∞·ª£c IP t·ª´ log. H√£y ki·ªÉm tra l·∫°i Token ho·∫∑c file ./pinggy"
    exit 1
fi

# T√°ch IP v√† Port cho Bedrock
B_IP=$(echo $BEDROCK_RAW | cut -d':' -f1)
B_PORT=$(echo $BEDROCK_RAW | cut -d':' -f2)

# --- G·ª¨I DISCORD ---
PAYLOAD=$(cat <<EOF
{
  "embeds": [{
    "title": "üéÆ SERVER MINECRAFT ASIA ONLINE",
    "description": "Server ƒëang ch·∫°y ·ªïn ƒë·ªãnh tr√™n server Ch√¢u √Å (Ping th·∫•p)",
    "color": 65280,
    "fields": [
      { "name": "üñ•Ô∏è JAVA EDITION", "value": "\`$JAVA_IP\`" },
      { "name": "üì± BEDROCK IP", "value": "\`$B_IP\`", "inline": true },
      { "name": "üî¢ PORT", "value": "\`$B_PORT\`", "inline": true }
    ],
    "footer": { "text": "Cung c·∫•p b·ªüi Pinggy Asia Tunnel" }
  }]
}
EOF
)

curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" $WEBHOOK_URL
echo "‚úÖ ƒê√£ g·ª≠i th√¥ng tin IP l√™n Discord th√†nh c√¥ng!"
