#!/bin/bash
WEBHOOK_URL="https://discord.com/api/webhooks/1460633815578968239/E5Ck-CCpCwQNUtGXA9z-VpWwcQzZz7M7meSapdb8i7f0cZ_XdnOg4EHeCQ6x4rfmga_2"
TOKEN="pt70EXJbPWH+"

if [ -z "$TMUX" ]; then
    tmux has-session -t mctunnel 2>/dev/null || tmux new-session -d -s mctunnel "/bin/bash $0"
    exit
fi

while true
do
    pkill -9 pinggy
    pkill -9 ssh
    sleep 5
    rm -f dual_log.txt

    # Kh·ªüi ch·∫°y qua SSH ƒë·ªÉ d·∫πp l·ªói TUI
    ssh -p 443 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -R0:0.0.0.0:25565 ${TOKEN}tcp+udp@ap.free.pinggy.io > dual_log.txt 2>&1 &
    
    sleep 15

    # L·ªçc l·∫•y IP s·∫°ch nh·∫•t, lo·∫°i b·ªè m·ªçi ti·ªÅn t·ªë tcp:// ho·∫∑c udp://
    RAW_LINK=$(grep -oE "[a-zA-Z0-9.-]+\.free\.pinggy\.(io|link):[0-9]+" dual_log.txt | head -n 1)

    if [ -z "$RAW_LINK" ]; then
        sleep 20
        continue
    fi

    # T√°ch IP v√† Port chu·∫©n cho Bedrock
    IP_ONLY=$(echo $RAW_LINK | cut -d':' -f1)
    PORT_ONLY=$(echo $RAW_LINK | cut -d':' -f2)

    PAYLOAD=$(cat <<EOF
{
  "embeds": [{
    "title": "üéÆ SERVER MINECRAFT ONLINE",
    "color": 3066993,
    "fields": [
      { "name": "üñ•Ô∏è JAVA (PC)", "value": "\`$RAW_LINK\`" },
      { "name": "üì± BEDROCK IP", "value": "\`$IP_ONLY\`", "inline": true },
      { "name": "üî¢ PORT", "value": "\`$PORT_ONLY\`", "inline": true }
    ],
    "footer": { "text": "L∆∞u √Ω: Geyser ph·∫£i ch·∫°y tr√™n port 25565" }
  }]
}
EOF
)
    curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" $WEBHOOK_URL
    echo "‚úÖ ƒê√£ g·ª≠i IP chu·∫©n: $RAW_LINK"
    sleep 3600
done
