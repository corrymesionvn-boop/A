#!/bin/bash

# Th√¥ng tin c·∫•u h√¨nh
WEBHOOK_URL="https://discord.com/api/webhooks/1460633815578968239/E5Ck-CCpCwQNUtGXA9z-VpWwcQzZz7M7meSapdb8i7f0cZ_XdnOg4EHeCQ6x4rfmga_2"
TOKEN="pt70EXJbPWH+"

# --- B∆Ø·ªöC 1: D·ªåN D·∫∏P S·∫†CH S·∫º ---
pkill -9 ssh
pkill -9 pinggy
tmux kill-session -t mctunnel 2>/dev/null

# Kh·ªüi t·∫°o tmux n·∫øu ch∆∞a c√≥
if [ -z "$TMUX" ]; then
    tmux new-session -d -s mctunnel "/bin/bash $0"
    echo "üöÄ ƒêang kh·ªüi ch·∫°y h·ªá th·ªëng (ƒê√£ fix l·ªói log tr·ªëng)..."
    exit
fi

while true
do
    echo "[$(date)] --- ƒêANG K·∫æT N·ªêI ---"
    pkill -9 ssh
    sleep 5
    rm -f dual_log.txt

    # --- B∆Ø·ªöC 2: K·∫æT N·ªêI V·ªöI CH·∫æ ƒê·ªò T·ª∞ CH·∫§P NH·∫¨N FINGERPRINT ---
    # Th√™m -o StrictHostKeyChecking=accept-new ƒë·ªÉ kh√¥ng bao gi·ªù b·ªã k·∫πt
    ssh -p 443 -o StrictHostKeyChecking=accept-new -o ServerAliveInterval=10 "${TOKEN}tcp+udp@ap.free.pinggy.io" -R0:0.0.0.0:25565 > dual_log.txt 2>&1 &
    
    echo "‚è≥ ƒê·ª£i 30 gi√¢y ƒë·ªÉ Pinggy c·∫•p IP (TƒÉng th·ªùi gian ƒë·ªÉ tr√°nh log tr·ªëng)..."
    sleep 30

    # --- B∆Ø·ªöC 3: L·ªåC IP SI√äU S·∫†CH ---
    # T√¨m d√≤ng c√≥ ƒë·ªãa ch·ªâ .pinggy.
    RAW_LINE=$(grep -oE "(tcp:\/\/|udp:\/\/|)[a-zA-Z0-9.-]+\.free\.pinggy\.(io|link):[0-9]+" dual_log.txt | head -n 1)

    if [ -z "$RAW_LINE" ]; then
        echo "‚ö†Ô∏è Log v·∫´n tr·ªëng ho·∫∑c ch∆∞a c√≥ IP. ƒêang th·ª≠ l·∫°i sau 20s..."
        # Ki·ªÉm tra n·ªôi dung log th·ª±c t·∫ø ƒë·ªÉ debug
        cat dual_log.txt
        sleep 20
        continue
    else
        # X√≥a s·∫°ch tcp:// v√† udp:// ƒë·ªÉ Bedrock/Java kh√¥ng b·ªã l·ªói
        CLEAN_IP=$(echo "$RAW_LINE" | sed 's/tcp:\/\///g' | sed 's/udp:\/\///g')

        # T√°ch IP v√† Port chu·∫©n cho Bedrock
        IP_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f1)
        PORT_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f2)

        # G·ª≠i Discord
        PAYLOAD=$(cat <<EOF
{
  "embeds": [{
    "title": "‚úÖ SERVER ONLINE (FIXED)",
    "description": "ƒê√£ s·ª≠a l·ªói x√°c th·ª±c SSH v√† l·ªçc s·∫°ch IP.",
    "color": 65280,
    "fields": [
      { "name": "üñ•Ô∏è JAVA ADDRESS", "value": "\`$CLEAN_IP\`" },
      { "name": "üì± BEDROCK IP", "value": "\`$IP_ONLY\`", "inline": true },
      { "name": "üî¢ PORT", "value": "\`$PORT_ONLY\`", "inline": true }
    ],
    "footer": { "text": "N·∫øu Bedrock kh√¥ng v√†o ƒë∆∞·ª£c, h√£y ki·ªÉm tra Geyser port 25565" }
  }]
}
EOF
)
        curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" $WEBHOOK_URL
        echo "‚úÖ Th√†nh c√¥ng! ƒê√£ g·ª≠i IP: $CLEAN_IP"
        
        # Treo 60 ph√∫t r·ªìi reset
        sleep 3600
    fi
done
    else
        # T√°ch IP v√† Port chu·∫©n cho Bedrock t·ª´ ƒë·ªãa ch·ªâ ƒë√£ l√†m s·∫°ch
        IP_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f1)
        PORT_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f2)

        PAYLOAD=$(cat <<EOF
{
  "embeds": [{
    "title": "‚úÖ SERVER MINECRAFT ƒê√É M·ªû",
    "description": "Geyser ƒë√£ ch·∫°y tr√™n port 25565. K·∫øt n·ªëi ·ªïn ƒë·ªãnh!",
    "color": 3066993,
    "fields": [
      { "name": "üñ•Ô∏è JAVA ADDRESS", "value": "\`$CLEAN_IP\`" },
      { "name": "üì± BEDROCK IP", "value": "\`$IP_ONLY\`", "inline": true },
      { "name": "üî¢ PORT", "value": "\`$PORT_ONLY\`", "inline": true }
    ],
    "footer": { "text": "H·ªá th·ªëng t·ª± reset sau m·ªói 60 ph√∫t" }
  }]
}
EOF
)
        curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" $WEBHOOK_URL
        echo "‚úÖ ƒê√£ g·ª≠i IP s·∫°ch l√™n Discord: $CLEAN_IP"
        sleep 3600
    fi
done
