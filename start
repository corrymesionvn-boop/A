#!/bin/bash

# Webhook v√† Token c·ªßa b·∫°n
WEBHOOK_URL="https://discord.com/api/webhooks/1460633815578968239/E5Ck-CCpCwQNUtGXA9z-VpWwcQzZz7M7meSapdb8i7f0cZ_XdnOg4EHeCQ6x4rfmga_2"
TOKEN="pt70EXJbPWH+"

# D·ªçn d·∫πp session c≈©
pkill -9 ssh
pkill -9 pinggy
tmux kill-session -t mctunnel 2>/dev/null

if [ -z "$TMUX" ]; then
    tmux new-session -d -s mctunnel "/bin/bash $0"
    echo "üöÄ Geyser ƒë√£ s·∫µn s√†ng! ƒêang m·ªü Tunnel..."
    exit
fi

while true
do
    pkill -9 ssh
    sleep 5
    rm -f dual_log.txt

    # M·ªü tunnel cho c·∫£ Java v√† Bedrock
    ssh -p 443 -o StrictHostKeyChecking=no -o ServerAliveInterval=10 "${TOKEN}tcp+udp@ap.free.pinggy.io" -R0:0.0.0.0:25565 > dual_log.txt 2>&1 &
    
    sleep 15

    # --- B·ªò L·ªåC TH√îNG MINH: CH·ªêNG NH·∫¶M L·∫™N ---
    # T√¨m ƒë·ªãa ch·ªâ c√≥ ƒëu√¥i .pinggy. v√† X√ìA S·∫†CH ti·ªÅn t·ªë tcp:// ho·∫∑c udp://
    CLEAN_IP=$(grep -oE "(tcp:\/\/|udp:\/\/|)[a-zA-Z0-9.-]+\.free\.pinggy\.(io|link):[0-9]+" dual_log.txt | head -n 1 | sed 's/tcp:\/\///g' | sed 's/udp:\/\///g')

    if [ -z "$CLEAN_IP" ]; then
        echo "‚ö†Ô∏è ƒêang ƒë·ª£i Pinggy c·∫•p IP..."
        sleep 20
        continue
    else
        # T√°ch IP v√† Port chu·∫©n cho Bedrock t·ª´ ƒë·ªãa ch·ªâ ƒë√£ l√†m s·∫°ch
        IP_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f1)
        PORT_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f2)

        PAYLOAD=$(cat <<EOF
{
  "embeds": [{
    "title": "‚úÖ SERVER MINECRAFT ƒê√É M·ªû",
    "description": "Geyser ƒë√£ ch·∫°y tr√™n port 25565. K·∫øt n·ªëi ·ªïn ƒë·ªãnh!",
    "color": 3066993,
    "fields": [
      { "name": "üñ•Ô∏è JAVA ADDRESS", "value": "\`$CLEAN_IP\`" },
      { "name": "üì± BEDROCK IP", "value": "\`$IP_ONLY\`", "inline": true },
      { "name": "üî¢ PORT", "value": "\`$PORT_ONLY\`", "inline": true }
    ],
    "footer": { "text": "H·ªá th·ªëng t·ª± reset sau m·ªói 60 ph√∫t" }
  }]
}
EOF
)
        curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" $WEBHOOK_URL
        echo "‚úÖ ƒê√£ g·ª≠i IP s·∫°ch l√™n Discord: $CLEAN_IP"
        sleep 3600
    fi
done
