#!/bin/bash

WEBHOOK_URL="https://discord.com/api/webhooks/1460633815578968239/E5Ck-CCpCwQNUtGXA9z-VpWwcQzZz7M7meSapdb8i7f0cZ_XdnOg4EHeCQ6x4rfmga_2"
TOKEN="pt70EXJbPWH+"

# --- S·ª¨A PH·∫¶N D·ªåN D·∫∏P ƒê·ªÇ TR√ÅNH B·ªä KILLED ---
# Ch·ªâ gi·∫øt c√°c ti·∫øn tr√¨nh ssh c√≥ li√™n quan ƒë·∫øn pinggy, kh√¥ng gi·∫øt to√†n b·ªô ssh
ps aux | grep "${TOKEN}" | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null
pkill -9 pinggy 2>/dev/null

tmux kill-session -t mctunnel 2>/dev/null

if [ -z "$TMUX" ]; then
    tmux new-session -d -s mctunnel "/bin/bash $0"
    echo "üöÄ ƒêang kh·ªüi ch·∫°y l·∫°i (ƒê√£ fix l·ªói b·ªã Killed)..."
    exit
fi

while true
do
    pkill -9 pinggy 2>/dev/null
    sleep 5
    rm -f dual_log.txt

    # Ch·∫°y SSH v·ªõi c√°c t√πy ch·ªçn ti·∫øt ki·ªám t√†i nguy√™n
    ssh -p 443 -o StrictHostKeyChecking=accept-new -o ServerAliveInterval=10 -o ServerAliveCountMax=3 "${TOKEN}tcp+udp@ap.free.pinggy.io" -R0:0.0.0.0:25565 > dual_log.txt 2>&1 &
    
    echo "ƒêang ƒë·ª£i IP..."
    sleep 20

    # Ki·ªÉm tra xem c√≥ l·∫•y ƒë∆∞·ª£c link kh√¥ng
    RAW_LINE=$(grep -oE "(tcp:\/\/|udp:\/\/|)[a-zA-Z0-9.-]+\.free\.pinggy\.(io|link):[0-9]+" dual_log.txt | head -n 1)

    if [ -z "$RAW_LINE" ]; then
        echo "‚ö†Ô∏è V·∫´n ch∆∞a c√≥ IP. Th·ª≠ l·∫°i sau 15s..."
        sleep 15
        continue
    else
        CLEAN_IP=$(echo "$RAW_LINE" | sed 's/tcp:\/\///g' | sed 's/udp:\/\///g')
        IP_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f1)
        PORT_ONLY=$(echo "$CLEAN_IP" | cut -d':' -f2)

        PAYLOAD=$(cat <<EOF
{
  "embeds": [{
    "title": "‚úÖ SERVER MINECRAFT ONLINE",
    "color": 3066993,
    "fields": [
      { "name": "üñ•Ô∏è JAVA", "value": "\`$CLEAN_IP\`" },
      { "name": "üì± BEDROCK", "value": "IP: \`$IP_ONLY\`\nPort: \`$PORT_ONLY\`" }
    ]
  }]
}
EOF
)
        curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" $WEBHOOK_URL
        echo "‚úÖ ƒê√£ g·ª≠i IP l√™n Discord."
        sleep 3600
    fi
done
